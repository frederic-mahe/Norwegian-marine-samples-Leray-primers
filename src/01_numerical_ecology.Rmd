---
title: " Norwegian Marine Samples COI (#1) "
author: "Frédéric Mahé"
date: '`r format(Sys.time(), "%d %B %Y")`'

output:
  rmarkdown::html_document:
    theme: lumen
    toc: yes
    toc_float: TRUE
    keep_md: yes
    # code_folding: hide
---

```{r setup, include=FALSE}
rm(list = ls()) # remove all objects before starting
knitr::opts_chunk$set(echo = TRUE)
```

***

#### load required packages

```{r packages, message=FALSE}
library(here)
library(tidyverse)
library(vegan)
```


# checks, taxonomic filtering, and subsampling

## variables and functions

```{r}
input <- "FDIR.Curated_LULU_20210729.csv"
rarefied_table <- str_replace(input, ".csv", "_protists_rarefied.csv")
min_target_size <- 10000  # minimal number of reads
non_protists <- c("Archaeplastida", "Opisthokonta", "Prokaryota")
min_number_of_reads <- 1000
seed <- 123
n_subsamplings <- 100
```

Force `dplyr` to read all the rows of the input table before guessing
the type of each column. Otherwise, the wrong type will be guessed for
some samples (`logical` instead of `double`). A more elegant solution
would be to indicate that all columns starting with `FD01_` to `FD04_`
are samples and should be interpreted as `double`, but that's not yet
possible with `dplyr`.

```{r}
load_raw_occurrence_data <- function(filename){
    here::here("data", filename) %>%
        read_delim(delim = ";",
                   na = c("0", "", "NA"),
                   guess_max = Inf,
                   show_col_types = FALSE)
}
```


### preliminary checks and filtering

here we go:

```{r}
load_raw_occurrence_data(input) -> raw_table
```

how many reads per superkingdom?

```{r}
raw_table %>%
    pivot_longer(cols = starts_with("FD0"),
                 names_to = "samples",
                 values_to = "reads",
                 values_drop_na = TRUE) %>%
    count(superkingdom_name, wt = reads, name = "reads") %>%
    mutate(percentage = 100 * reads / sum(reads))
```

note the number of unassigned reads (`NA`), or reads assigned to
`Prokaryota` (are these alphaproteobacteria?). The next step is to
eliminate unassigned OTUs and OTUs assigned to plants, animals and
bacteria:

```{r}
raw_table %>%
    filter(! is.na(superkingdom_name) &
           ! superkingdom_name %in% non_protists) %>%
    select(id, starts_with("FD0")) -> protists_table
```

compute the number of reads per sample:

```{r}
protists_table %>%
    pivot_longer(cols = starts_with("FD0"),
                 names_to = "samples",
                 values_to = "reads",
                 values_drop_na = TRUE) %>%
    count(samples, wt = reads, name = "reads", sort = TRUE) %>%
    filter(reads < min_number_of_reads) %>%
    summarise(n()) %>%
    pull() -> number_of_small_samples
```

there are `r prettyNum(number_of_small_samples, scientific=FALSE, big.mark=",")`
samples with less than `r prettyNum(min_number_of_reads, scientific=FALSE, big.mark=",")` reads.


***

```{r}
sessionInfo()
rm(list = ls())
```
